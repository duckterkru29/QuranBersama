<!DOCTYPE html>
<html lang="id" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuranBersama - Al-Quran, Hadits & Amalan Harian</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ==========================================
           CSS VARIABLES - LIGHT MODE (DEFAULT)
           ========================================== */
        :root {
            --primary: #025043;
            --secondary: #0a705e;
            --accent: #E5B443;
            --bg: #f5f8f7;
            --card: rgba(255, 255, 255, 0.85);
            --text: #1f2937;
            --text-secondary: #5a6b65;
            --border: rgba(2, 80, 67, 0.08);
            --shadow: 0 4px 25px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.06);
            --success: #10b981;
            --warning: #f59e0b;
            --gradient-start: #eef2f1;
            --gradient-end: #f8faf9;
            --glass-blur: blur(12px);
        }

        /* ==========================================
           DARK MODE VARIABLES
           ========================================== */
        [data-theme="dark"] {
            --primary: #0d9488;
            --secondary: #0f766e;
            --accent: #eab308;
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.75);
            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 4px 25px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.5);
            --gradient-start: #020617;
            --gradient-end: #0f172a;
            --glass-blur: blur(16px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text);
            position: relative;
        }

        body.tajweed-active .ghunnah {
            color: #F59E0B;
        }

        body.tajweed-active .idgham_ghunnah {
            color: #8B5CF6;
        }

        body.tajweed-active .idgham_wo_ghunnah {
            color: #9CA3AF;
        }

        body.tajweed-active .idgham_mutajanisayn,
        body.tajweed-active .idgham_mutaqaribayn,
        body.tajweed-active .idgham_shafawi {
            color: #86EFAC;
        }

        body.tajweed-active .iqlab {
            color: #3B82F6;
        }

        body.tajweed-active .ikhafa {
            color: #EF4444;
        }

        body.tajweed-active .ikhafa_shafawi {
            color: #EC4899;
        }

        body.tajweed-active .qalaqah {
            color: #10B981;
        }

        body.tajweed-active .ham_wasl,
        body.tajweed-active .silent {
            color: #9CA3AF;
        }

        body.tajweed-active .madda_normal,
        body.tajweed-active .madda_permissible,
        body.tajweed-active .madda_necessary_light,
        body.tajweed-active .madda_necessary_heavy,
        body.tajweed-active .madda_obligatory {
            color: #F47672;
        }

        /* ==========================================
           TOGGLE SWITCH STYLES
           ========================================== */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        body::before {
            content: '';
            position: fixed;
            top: -15vw;
            right: -15vw;
            width: 60vw;
            height: 60vw;
            background: radial-gradient(circle, var(--shadow-lg) 0%, transparent 60%);
            border-radius: 50%;
            z-index: -1;
            opacity: 0.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* CSS removed from here as it is now above with .tajweed-active */

        .verse-container {
            display: flex;
            flex-wrap: wrap;
            flex-direction: row-reverse;
            gap: 2px;
            margin-bottom: 20px;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .word-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s;
            padding: 0 2px;
            /* reduced padding */
            border-radius: 4px;
        }

        .word-group:hover {
            background: var(--border);
        }

        .word-arabic {
            font-size: var(--arabic-font-size, 2.2em);
            font-family: 'Amiri', 'Traditional Arabic', serif;
            line-height: 1.8;
            direction: rtl;
            white-space: nowrap;
        }

        .word-latin {
            font-size: var(--latin-font-size, 0.9em);
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .font-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .font-controls button {
            padding: 8px 15px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: filter 0.2s;
        }

        .font-controls button:hover {
            filter: brightness(1.1);
        }


        /* ==========================================
           HEADER & THEME TOGGLE
           ========================================== */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 30px;
            padding: 50px 20px;
            margin-bottom: 50px;
            box-shadow: 0 25px 50px -12px var(--shadow-lg);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                radial-gradient(rgba(212, 175, 55, 0.15) 1px, transparent 1px);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            opacity: 0.8;
            pointer-events: none;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        [data-theme="dark"] .control-btn {
            background: rgba(0, 0, 0, 0.3);
            color: var(--accent);
        }

        h1 {
            color: var(--accent);
            font-family: 'Amiri', serif;
            font-size: 3em;
            margin-bottom: 15px;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        .subtitle {
            color: #E5E7EB;
            font-size: 1.2em;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }

        /* ==========================================
           NAVIGATION
           ========================================== */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-btn {
            padding: 14px 28px;
            border: 1px solid var(--border);
            background: var(--card);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px var(--shadow);
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px var(--shadow-lg);
            border-color: var(--primary);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px var(--shadow-lg);
            border-color: transparent;
        }

        [data-theme="dark"] .nav-btn {
            color: var(--text);
        }

        [data-theme="dark"] .nav-btn.active {
            color: var(--accent);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--card);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: 28px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.4s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        /* ==========================================
           QIBLA COMPASS STYLES
           ========================================== */
        .qibla-container {
            text-align: center;
            padding: 40px 20px;
        }

        .compass-wrapper {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 30px auto;
        }

        .compass-outer {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--card), var(--bg));
            box-shadow:
                20px 20px 60px var(--shadow),
                -20px -20px 60px rgba(255, 255, 255, 0.1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 8px solid var(--accent);
        }

        [data-theme="dark"] .compass-outer {
            background: linear-gradient(145deg, #1E293B, #0F172A);
            box-shadow:
                20px 20px 60px rgba(0, 0, 0, 0.5),
                -20px -20px 60px rgba(255, 255, 255, 0.05);
        }

        .compass-inner {
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: var(--card);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border);
        }

        [data-theme="dark"] .compass-inner {
            background: #1E293B;
        }

        .compass-face {
            width: 100%;
            height: 100%;
            position: absolute;
            border-radius: 50%;
        }

        .compass-marker {
            position: absolute;
            font-size: 0.8em;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .marker-n {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #e74c3c;
            font-size: 1.2em;
        }

        .marker-s {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .marker-e {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .marker-w {
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .compass-needle {
            width: 4px;
            height: 120px;
            background: linear-gradient(to bottom, #e74c3c 50%, #2c3e50 50%);
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%) translateY(-100%) rotate(0deg);
            border-radius: 2px;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }

        .compass-needle::before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 15px solid #e74c3c;
        }

        .compass-needle::after {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 15px solid #2c3e50;
        }

        .qibla-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            transform: translate(-50%, -50%);
            z-index: 5;
        }

        .qibla-arrow {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid var(--accent);
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .qibla-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            white-space: nowrap;
        }

        .compass-center {
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 15;
            border: 3px solid var(--accent);
        }

        .qibla-info {
            background: var(--card);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid var(--border);
        }

        .qibla-info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .qibla-info-item:last-child {
            border-bottom: none;
        }

        .qibla-info-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .qibla-info-value {
            font-weight: 600;
            color: var(--primary);
        }

        .calibrate-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .calibrate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 78, 59, 0.3);
        }

        .calibrate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ==========================================
           QURAN STYLES
           ========================================== */
        .surah-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .surah-item {
            background: var(--card);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            padding: 24px;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .surah-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .surah-item:hover {
            transform: translateY(-6px);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: var(--shadow-lg);
        }

        .surah-item:hover::before {
            opacity: 1;
        }

        .surah-number {
            display: inline-flex;
            width: 42px;
            height: 42px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 14px;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 12px;
        }

        .arabic-text {
            font-family: 'Amiri', serif;
            font-size: 1.8em;
            text-align: right;
            line-height: 2;
            color: var(--primary);
            margin: 20px 0;
        }

        [data-theme="dark"] .arabic-text {
            color: var(--secondary);
        }

        .translation {
            text-align: left;
            color: var(--text-secondary);
            line-height: 1.8;
            padding: 15px;
            background: var(--bg);
            border-radius: 10px;
            margin-top: 10px;
            border-left: 4px solid var(--accent);
        }

        .ayah-card {
            background: var(--card);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: 24px;
            padding: 35px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            scroll-margin-top: 100px;
            border: 1px solid var(--border);
        }

        .ayah-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .ayah-card.playing {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, var(--card) 100%);
            border: 1px solid var(--primary);
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .ayah-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary);
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 12px 25px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 5px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            filter: brightness(1.1);
        }

        select.btn-primary option {
            background-color: var(--card);
            color: var(--text);
            font-size: initial;
        }

        .btn-success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        /* ==========================================
           HADITS STYLES
           ========================================== */
        .hadits-card {
            background: var(--card);
            padding: 35px;
            margin-bottom: 25px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            transition: all 0.4s ease;
        }

        .hadits-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .hadits-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .hadits-source {
            background: var(--accent);
            color: var(--primary);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .hadits-arab {
            font-family: 'Amiri', serif;
            font-size: var(--arabic-font-size, 1.4em);
            line-height: 2;
            text-align: right;
            margin: 15px 0;
            color: var(--text);
        }

        .hadits-translation {
            color: var(--text-secondary);
            line-height: 1.8;
            font-style: italic;
        }

        /* ==========================================
           PRAYER TIMES STYLES
           ========================================== */
        .prayer-times-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .prayer-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .prayer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(6, 78, 59, 0.2);
        }

        .prayer-card.active {
            background: linear-gradient(135deg, var(--accent) 0%, #B8860B 100%);
            color: var(--primary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .prayer-name {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .prayer-time {
            font-size: 1.5em;
            font-weight: 700;
        }

        .location-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .location-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1em;
            background: var(--card);
            color: var(--text);
        }

        /* ==========================================
           SIJIL STYLES
           ========================================== */
        .date-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .current-date {
            font-size: 1.5em;
            color: var(--primary);
            font-weight: 600;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .activity-category {
            background: var(--card);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px var(--shadow);
            border: 1px solid var(--border);
        }

        .category-title {
            font-size: 1.3em;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--accent);
        }

        .activity-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--bg);
            border-radius: 12px;
            transition: all 0.3s;
            border: 1px solid var(--border);
        }

        .activity-item:hover {
            background: var(--card);
            transform: translateX(5px);
        }

        .activity-item.completed {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--success);
        }

        .activity-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .activity-icon {
            width: 45px;
            height: 45px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .checkbox-wrapper {
            position: relative;
        }

        .custom-checkbox {
            width: 30px;
            height: 30px;
            border: 3px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .custom-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .custom-checkbox.checked::after {
            content: 'âœ“';
            color: white;
            font-weight: bold;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: var(--accent);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 5px;
            transition: width 0.5s;
        }

        .reading-tracker {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, var(--card) 100%);
            border: 2px solid var(--accent);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .reading-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .reading-stat-box {
            background: var(--card);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 3px 10px var(--shadow);
            border: 1px solid var(--border);
        }

        .reading-stat-number {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
        }

        /* ==========================================
           MODAL & NOTIFICATION
           ========================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            border-radius: 25px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            background: var(--primary);
            color: white;
            padding: 25px;
            border-radius: 25px 25px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 25px;
            color: var(--text);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: none;
            animation: slideIn 0.3s;
            z-index: 2000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
            }

            to {
                transform: translateX(0);
            }
        }

        .quran-reader-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .audio-btn {
            background: var(--accent);
            color: var(--primary);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .audio-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        .audio-btn.playing {
            background: var(--primary);
            color: var(--accent);
            animation: pulse 2s infinite;
        }

        .bismillah {
            text-align: center;
            font-family: 'Amiri', serif;
            font-size: 2em;
            color: var(--primary);
            margin: 30px 0;
        }

        /* ==========================================
           LOADING & RESPONSIVE
           ========================================== */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--bg);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .nav-btn {
                padding: 12px 20px;
                font-size: 0.9em;
            }

            .arabic-text {
                font-size: 1.4em;
            }

            .prayer-times-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .compass-wrapper {
                width: 250px;
                height: 250px;
            }

            .compass-inner {
                width: 210px;
                height: 210px;
            }

            .header-controls {
                top: 10px;
                right: 10px;
            }

            .control-btn {
                width: 35px;
                height: 35px;
                font-size: 1em;
            }
        }

        /* Permission dialog */
        .permission-dialog {
            background: var(--card);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid var(--accent);
            text-align: center;
        }

        .permission-dialog i {
            font-size: 3em;
            color: var(--accent);
            margin-bottom: 15px;
        }

        .permission-dialog h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .permission-dialog p {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-controls">
                <button class="control-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
            <h1><i class="fas fa-mosque"></i> QuranBersama</h1>
            <p class="subtitle">Al-Quran, Hadits Shahih, Jadwal Shalat & Catatan Amal Harian</p>
        </header>

        <nav class="nav-tabs"
            style="background: rgba(var(--primary-rgb), 0.05); padding: 8px; border-radius: 50px; display: inline-flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin: 0 auto 40px auto; border: 1px solid var(--border); box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);">
            <button class="nav-btn active" onclick="showSection('quran')">
                <i class="fas fa-book-open"></i> <span style="margin-left:5px">Al-Quran</span>
            </button>
            <button class="nav-btn" onclick="showSection('hadits')">
                <i class="fas fa-scroll"></i> <span style="margin-left:5px">Hadits</span>
            </button>
            <button class="nav-btn" onclick="showSection('prayer')">
                <i class="fas fa-clock"></i> <span style="margin-left:5px">Waktu Shalat</span>
            </button>
            <button class="nav-btn" onclick="showSection('qibla')">
                <i class="fas fa-compass"></i> <span style="margin-left:5px">Kiblat</span>
            </button>
            <button class="nav-btn" onclick="showSection('sijil')">
                <i class="fas fa-calendar-check"></i> <span style="margin-left:5px">Amalan</span>
            </button>
        </nav>

        <!-- Al-Quran Section -->
        <section id="quran" class="content-section active">
            <div class="card" style="padding: 20px 30px;">
                <div id="surahListView">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                        <h2 style="color: var(--primary); font-size: 1.8em; font-weight: 700;">
                            <i class="fas fa-list-ul" style="color: var(--accent); margin-right: 10px;"></i> Daftar
                            Surah
                        </h2>
                        <div style="display: flex; gap: 10px; flex: 1; max-width: 600px;">
                            <div style="position: relative; flex: 2;">
                                <i class="fas fa-search"
                                    style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                                <input type="text" id="searchSurah" placeholder="Cari Surah..."
                                    style="width: 100%; padding: 14px 14px 14px 45px; border: 1px solid var(--border); border-radius: 12px; font-size: 1em; background: var(--card); color: var(--text); box-shadow: inset 0 2px 4px var(--shadow); transition: all 0.3s;"
                                    onkeyup="filterSurah()" onfocus="this.style.borderColor='var(--primary)'"
                                    onblur="this.style.borderColor='var(--border)'">
                            </div>
                            <div style="position: relative; flex: 1;">
                                <i class="fas fa-book-open"
                                    style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none;"></i>
                                <select id="juzSelect" onchange="loadJuz()"
                                    style="width: 100%; padding: 14px 14px 14px 45px; border: 1px solid var(--border); border-radius: 12px; font-size: 1em; background: var(--card); color: var(--text); box-shadow: inset 0 2px 4px var(--shadow); cursor: pointer; appearance: none;">
                                    <option value="">Juz</option>
                                    <script>
                                        for (let i = 1; i <= 30; i++) document.write(`<option value="${i}">Juz ${i}</option>`);
                                    </script>
                                </select>
                                <i class="fas fa-chevron-down"
                                    style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none;"></i>
                            </div>
                        </div>
                    </div>
                    <div id="surahList" class="surah-list">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <div id="surahDetailView" style="display: none;">
                    <div class="quran-reader-header"
                        style="position: sticky; top: 0; background: var(--card); padding: 15px 0; z-index: 100; border-bottom: 1px solid var(--border); margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);">
                        <button class="btn-primary" onclick="backToSurahList()"
                            style="margin: 0; padding: 10px 20px; border-radius: 50px; background: rgba(var(--primary-rgb), 0.1); color: var(--primary); border: none; box-shadow: none;">
                            <i class="fas fa-arrow-left"></i> Kembali
                        </button>

                        <div style="flex: 1; min-width: 250px; max-width: 400px; position: relative;">
                            <i class="fas fa-search"
                                style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                            <input type="text" id="searchAyah" placeholder="Cari ayat atau terjemahan..."
                                style="width: 100%; padding: 12px 14px 12px 45px; border: 1px solid var(--border); border-radius: 50px; background: var(--bg); color: var(--text); font-size: 0.9em; transition: all 0.3s;"
                                onkeyup="filterAyah()"
                                onfocus="this.style.borderColor='var(--primary); this.style.boxShadow=\'0 0 0 3px rgba(13, 148, 136, 0.2)\';'"
                                onblur="this.style.borderColor='var(--border); this.style.boxShadow=\'none\';'">
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button class="btn-primary" onclick="toggleFullSurah()" id="fullSurahBtn"
                                style="margin: 0; padding: 10px 25px; border-radius: 50px;">
                                <i class="fas fa-play" id="fullSurahBtnIcon" style="margin-right: 5px;"></i>
                                <span id="fullSurahBtnText">Putar Murottal</span>
                            </button>
                            <button class="btn-primary" onclick="showSettingsModal()"
                                style="margin: 0; width: 45px; height: 45px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--bg); color: var(--text); border: 1px solid var(--border); box-shadow: none;"
                                title="Pengaturan Tampilan">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div id="surahContent"></div>
                </div>
            </div>
        </section>

        <!-- Hadits Section -->
        <section id="hadits" class="content-section">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: var(--primary);">
                    <i class="fas fa-book-open"></i> Kumpulan Hadits Shahih
                </h2>

                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <select id="haditsSource" class="btn-primary" style="flex: 2; padding: 12px; border-radius: 8px;"
                        onchange="loadHadits()">
                        <option value="bukhari">Shahih Bukhari</option>
                        <option value="muslim">Shahih Muslim</option>
                        <option value="tirmidzi">Sunan At-Tirmidzi</option>
                        <option value="nasai">Sunan An-Nasa'i</option>
                        <option value="abu-daud">Sunan Abu Daud</option>
                        <option value="ibnu-majah">Sunan Ibnu Majah</option>
                        <option value="ahmad">Musnad Ahmad</option>
                        <option value="darimi">Sunan Ad-Darimi</option>
                        <option value="malik">Muwatta Malik</option>
                    </select>

                    <button class="btn-primary" onclick="showHaditsSettingsModal()"
                        style="margin: 0; width: 45px; height: 45px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--bg); color: var(--text); border: 1px solid var(--border); box-shadow: none;"
                        title="Pengaturan Tampilan">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="text" id="searchMainHadits" placeholder="Cari terjemahan atau potongan kata..."
                        class="btn-primary"
                        style="flex: 2; padding: 12px; border-radius: 8px; background: var(--card); color: var(--text); border: 1px solid var(--border); box-shadow: inset 0 2px 4px var(--shadow);"
                        onkeyup="filterMainHadits()">
                </div>

                <div id="haditsInfoBar"
                    style="background: rgba(13, 148, 136, 0.1); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-weight: 600; color: var(--primary); text-align: center;">
                    Menyiapkan Koleksi...
                </div>

                <div id="haditsContent">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="loadMoreHaditsBtn" class="btn-primary" onclick="loadMoreHadits()"
                        style="display: none;">
                        <i class="fas fa-plus"></i> Muat Hadits Lainnya
                    </button>
                </div>
            </div>
        </section>

        <!-- Prayer Times Section -->
        <section id="prayer" class="content-section">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: var(--primary);">
                    <i class="fas fa-location-dot"></i> Jadwal Shalat
                </h2>
                <div class="location-input">
                    <input type="text" id="cityInput"
                        placeholder="Masukkan nama kota (contoh: Jakarta, Bandung, Surabaya)..." value="Jakarta">
                    <button class="btn-primary" onclick="getPrayerTimes()">
                        <i class="fas fa-search"></i> Cari
                    </button>
                    <button class="btn-primary" onclick="getLocation()" title="Gunakan Lokasi Saat Ini">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                </div>
                <div id="prayerTimesContent">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Qibla Section (NEW) -->
        <section id="qibla" class="content-section">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: var(--primary);">
                    <i class="fas fa-compass"></i> Penunjuk Arah Kiblat
                </h2>

                <div id="qiblaPermission" class="permission-dialog" style="display: none;">
                    <i class="fas fa-compass"></i>
                    <h3>Izin Diperlukan</h3>
                    <p>Untuk menampilkan arah kiblat dengan akurat, kami memerlukan akses ke lokasi dan orientasi
                        perangkat Anda.</p>
                    <button class="btn-primary" onclick="requestQiblaPermission()">
                        <i class="fas fa-location-arrow"></i> Izinkan Akses
                    </button>
                </div>

                <div id="qiblaContent" style="display: none;">
                    <div class="qibla-container">
                        <div class="compass-wrapper">
                            <div class="compass-outer">
                                <div class="compass-inner">
                                    <div class="compass-face">
                                        <span class="compass-marker marker-n">N</span>
                                        <span class="compass-marker marker-e">E</span>
                                        <span class="compass-marker marker-s">S</span>
                                        <span class="compass-marker marker-w">W</span>
                                    </div>
                                    <div class="compass-needle" id="compassNeedle"></div>
                                    <div class="qibla-indicator" id="qiblaIndicator" style="display: none;">
                                        <div class="qibla-arrow"></div>
                                        <div class="qibla-label">KIBLAT</div>
                                    </div>
                                    <div class="compass-center"></div>
                                </div>
                            </div>
                        </div>

                        <div class="qibla-info">
                            <div class="qibla-info-item">
                                <span class="qibla-info-label">Arah Kiblat</span>
                                <span class="qibla-info-value" id="qiblaDirection">-</span>
                            </div>
                            <div class="qibla-info-item">
                                <span class="qibla-info-label">Jarak ke Ka'bah</span>
                                <span class="qibla-info-value" id="qiblaDistance">-</span>
                            </div>
                            <div class="qibla-info-item">
                                <span class="qibla-info-label">Lokasi Anda</span>
                                <span class="qla-info-value" id="userLocation">-</span>
                            </div>
                            <div class="qibla-info-item">
                                <span class="qibla-info-label">Orientasi</span>
                                <span class="qibla-info-value" id="deviceOrientation">-</span>
                            </div>
                        </div>

                        <button class="calibrate-btn" onclick="calibrateCompass()" id="calibrateBtn">
                            <i class="fas fa-sync-alt"></i> Kalibrasi Ulang
                        </button>

                        <p style="margin-top: 15px; color: var(--text-secondary); font-size: 0.9em;">
                            <i class="fas fa-info-circle"></i>
                            Arahkan ujung merah jarum kompas ke arah Utara (N) untuk menemukan kiblat
                        </p>
                    </div>
                </div>

                <div id="qiblaLoading" class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>

        <!-- Sijil Tsaksiyah Section -->
        <section id="sijil" class="content-section">
            <div class="reading-tracker">
                <div class="tracker-header">
                    <div>
                        <h3 style="color: var(--primary); margin-bottom: 5px;">
                            <i class="fas fa-chart-line"></i> Statistik Tadarus
                        </h3>
                        <p style="color: #666;">Otomatis tercatat saat membaca Al-Quran</p>
                    </div>
                    <button class="btn-primary" onclick="resetDailyStats()">
                        <i class="fas fa-rotate-right"></i> Reset Harian
                    </button>
                </div>
                <div class="reading-stats">
                    <div class="reading-stat-box">
                        <div class="reading-stat-number" id="ayahsReadToday">0</div>
                        <div>Ayat Dibaca Hari Ini</div>
                    </div>
                    <div class="reading-stat-box">
                        <div class="reading-stat-number" id="pagesReadToday">0</div>
                        <div>Halaman Setara</div>
                    </div>
                    <div class="reading-stat-box">
                        <div class="reading-stat-number" id="currentSurah">-</div>
                        <div>Surah Terakhir</div>
                    </div>
                    <div class="reading-stat-box">
                        <div class="reading-stat-number" id="readingStreak">0</div>
                        <div>Hari Berturut-turut</div>
                    </div>
                </div>
            </div>

            <div class="stats-card">
                <h3 style="margin-bottom: 10px;"><i class="fas fa-trophy"></i> Progress Harian</h3>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Selesai: <span id="completedCount">0</span>/<span id="totalCount">0</span></span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="ibadahScore">0</div>
                        <div>Ibadah</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="olahragaScore">0</div>
                        <div>Olahraga</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="sosialScore">0</div>
                        <div>Sosial</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalScore">0</div>
                        <div>Total Skor</div>
                    </div>
                </div>
            </div>

            <div class="date-header">
                <div class="current-date" id="currentDate"></div>
                <p style="color: #666; margin-top: 10px;" id="islamicDate"></p>
            </div>

            <div class="activity-grid" id="activityGrid">
                <!-- Activities will be generated by JavaScript -->
            </div>
        </section>
    </div>

    <!-- Modal -->
    <div id="quranModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Baca Al-Quran</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Word Detail Modal -->
    <div id="wordModal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h3>Detail Kata</h3>
                <button class="close-btn" onclick="closeWordModal()">&times;</button>
            </div>
            <div class="modal-body" id="wordModalBody" style="font-size: 1.1em;">
                <!-- Word content goes here -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // ==========================================
        // GLOBAL VARIABLES
        // ==========================================
        let allSurahs = [];
        let currentSurah = null;
        let currentAyah = 0;
        let haditsPage = 1;
        let currentAudio = null;
        let isPlayingFullSurah = false;
        let currentPlayingAyahIndex = 0;
        let currentTranslationId = '33';
        let currentArabicScript = 'text_uthmani';
        let currentTajweedOn = true;
        let activities = {};
        let quranStats = {
            ayahsRead: 0,
            pagesRead: 0,
            lastRead: null,
            streak: 0,
            lastDate: null
        };

        // Qibla variables
        let qiblaData = {
            latitude: null,
            longitude: null,
            qiblaAngle: null,
            distance: null,
            deviceHeading: 0
        };
        let compassEventListener = null;

        // ==========================================
        // THEME MANAGEMENT
        // ==========================================
        function initTheme() {
            const savedTheme = localStorage.getItem('quranbersama-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('quranbersama-theme', newTheme);
            updateThemeIcon(newTheme);

            showNotification(newTheme === 'dark' ? 'Dark Mode diaktifkan' : 'Light Mode diaktifkan');
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // ==========================================
        // ACTIVITY CATEGORIES
        // ==========================================
        const activityCategories = {
            ibadah: {
                title: 'Ibadah',
                icon: 'fa-pray',
                color: '#1e3a5f',
                items: [
                    { id: 'shubuh', name: 'Shalat Shubuh', icon: 'fa-sun' },
                    { id: 'dzuhur', name: 'Shalat Dzuhur', icon: 'fa-sun' },
                    { id: 'ashar', name: 'Shalat Ashar', icon: 'fa-cloud-sun' },
                    { id: 'maghrib', name: 'Shalat Maghrib', icon: 'fa-moon' },
                    { id: 'isya', name: 'Shalat Isya', icon: 'fa-star' },
                    { id: 'tahajjud', name: 'Shalat Tahajjud (Lail)', icon: 'fa-star-and-crescent' },
                    { id: 'tadarus', name: 'Tadarus Quran & Terjemahan', icon: 'fa-book-quran', autoTrack: true },
                    { id: 'puasa', name: 'Puasa', icon: 'fa-utensils' }
                ]
            },
            olahraga: {
                title: 'Olahraga',
                icon: 'fa-dumbbell',
                color: '#e74c3c',
                items: [
                    { id: 'lari', name: 'Lari/Jogging', icon: 'fa-person-running' },
                    { id: 'pushup', name: 'Push Up', icon: 'fa-hand-fist' },
                    { id: 'angkatbeban', name: 'Angkat Beban', icon: 'fa-dumbbell' },
                    { id: 'beladiri', name: 'Bela Diri', icon: 'fa-hand-sparkles' },
                    { id: 'situp', name: 'Sit Up', icon: 'fa-user' },
                    { id: 'futsal', name: 'Sepak Bola/Futsal', icon: 'fa-futbol' },
                    { id: 'renang', name: 'Renang', icon: 'fa-person-swimming' }
                ]
            },
            sosial: {
                title: 'Sosial & Kajian',
                icon: 'fa-users',
                color: '#27ae60',
                items: [
                    { id: 'silaturahmi', name: 'Silaturahmi', icon: 'fa-handshake' },
                    { id: 'kajian', name: 'Datang Kajian', icon: 'fa-book-open' }
                ]
            }
        };

        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', function () {
            document.body.classList.add('tajweed-active');
            initTheme();
            loadSurahList();
            loadHadits();
            getPrayerTimes();
            initializeSijil();
            updateDate();
            loadStats();
            checkNewDay();
        });

        // ==========================================
        // NAVIGATION
        // ==========================================
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            if (sectionId === 'sijil') {
                updateProgress();
            } else if (sectionId === 'qibla') {
                initQibla();
            } else {
                stopCompass();
            }
        }

        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
            document.getElementById('islamicDate').textContent = '1446 H';
        }

        // ==========================================
        // QIBLA COMPASS FUNCTIONS
        // ==========================================
        function initQibla() {
            const permissionDiv = document.getElementById('qiblaPermission');
            const contentDiv = document.getElementById('qiblaContent');
            const loadingDiv = document.getElementById('qiblaLoading');

            // Check if we already have permission
            if (qiblaData.latitude && qiblaData.longitude) {
                permissionDiv.style.display = 'none';
                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';
                startCompass();
                return;
            }

            // Check if geolocation is available
            if (!navigator.geolocation) {
                showNotification('Browser tidak mendukung geolokasi', 'error');
                return;
            }

            permissionDiv.style.display = 'block';
            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'none';
        }

        function requestQiblaPermission() {
            const permissionDiv = document.getElementById('qiblaPermission');
            const contentDiv = document.getElementById('qiblaContent');
            const loadingDiv = document.getElementById('qiblaLoading');

            permissionDiv.style.display = 'none';
            loadingDiv.style.display = 'block';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    qiblaData.latitude = position.coords.latitude;
                    qiblaData.longitude = position.coords.longitude;

                    // Calculate Qibla direction
                    calculateQibla();

                    // Get location name
                    getLocationName(qiblaData.latitude, qiblaData.longitude);

                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';

                    startCompass();
                    showNotification('Lokasi berhasil dideteksi');
                },
                (error) => {
                    loadingDiv.style.display = 'none';
                    permissionDiv.style.display = 'block';
                    showNotification('Gagal mendapatkan lokasi: ' + error.message, 'error');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function calculateQibla() {
            // Ka'bah coordinates
            const kaabaLat = 21.422487;
            const kaabaLng = 39.826206;

            const userLat = qiblaData.latitude * Math.PI / 180;
            const userLng = qiblaData.longitude * Math.PI / 180;
            const kaabaLatRad = kaabaLat * Math.PI / 180;
            const kaabaLngRad = kaabaLng * Math.PI / 180;

            // Calculate Qibla angle
            const y = Math.sin(kaabaLngRad - userLng);
            const x = Math.cos(userLat) * Math.tan(kaabaLatRad) - Math.sin(userLat) * Math.cos(kaabaLngRad - userLng);

            let qiblaAngle = Math.atan2(y, x) * 180 / Math.PI;
            qiblaAngle = (qiblaAngle + 360) % 360;

            qiblaData.qiblaAngle = qiblaAngle;

            // Calculate distance
            const R = 6371; // Earth's radius in km
            const dLat = kaabaLatRad - userLat;
            const dLng = kaabaLngRad - userLng;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(userLat) * Math.cos(kaabaLatRad) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;

            qiblaData.distance = distance;

            // Update UI
            document.getElementById('qiblaDirection').textContent = qiblaAngle.toFixed(1) + 'Â°';
            document.getElementById('qiblaDistance').textContent = distance.toFixed(0) + ' km';

            // Show Qibla indicator
            const indicator = document.getElementById('qiblaIndicator');
            if (indicator) {
                indicator.style.display = 'block';
                indicator.style.transform = `translate(-50%, -50%) rotate(${qiblaAngle}deg)`;
            }
        }

        function getLocationName(lat, lng) {
            // Simple reverse geocoding using OpenStreetMap
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`)
                .then(response => response.json())
                .then(data => {
                    const location = data.display_name.split(',').slice(0, 2).join(', ');
                    document.getElementById('userLocation').textContent = location;
                })
                .catch(() => {
                    document.getElementById('userLocation').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                });
        }

        function startCompass() {
            // Check for DeviceOrientationEvent
            if (window.DeviceOrientationEvent) {
                // iOS 13+ requires permission
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                addCompassListener();
                            } else {
                                showNotification('Izin orientasi ditolak', 'error');
                                // Fallback to manual mode
                                document.getElementById('deviceOrientation').textContent = 'Manual';
                            }
                        })
                        .catch(console.error);
                } else {
                    addCompassListener();
                }
            } else {
                showNotification('Kompas tidak didukung di perangkat ini', 'error');
                document.getElementById('deviceOrientation').textContent = 'Tidak tersedia';
            }
        }

        function addCompassListener() {
            compassEventListener = (event) => {
                let heading = 0;

                // iOS
                if (event.webkitCompassHeading) {
                    heading = event.webkitCompassHeading;
                }
                // Android
                else if (event.alpha !== null) {
                    heading = 360 - event.alpha;
                }

                qiblaData.deviceHeading = heading;
                updateCompass(heading);
            };

            window.addEventListener('deviceorientation', compassEventListener);
        }

        function updateCompass(heading) {
            const needle = document.getElementById('compassNeedle');
            if (needle) {
                needle.style.transform = `translateX(-50%) translateY(-100%) rotate(${heading}deg)`;
            }

            // Update orientation text
            const directions = ['Utara', 'Timur Laut', 'Timur', 'Tenggara', 'Selatan', 'Barat Daya', 'Barat', 'Barat Laut'];
            const index = Math.round(heading / 45) % 8;
            document.getElementById('deviceOrientation').textContent = directions[index] + ` (${Math.round(heading)}Â°)`;

            // Check if facing qibla (within 15 degrees)
            if (qiblaData.qiblaAngle) {
                const diff = Math.abs(heading - qiblaData.qiblaAngle);
                const normalizedDiff = Math.min(diff, 360 - diff);

                if (normalizedDiff < 15) {
                    document.getElementById('deviceOrientation').innerHTML += ' <span style="color: var(--success);">âœ“ Kiblat</span>';
                }
            }
        }

        function stopCompass() {
            if (compassEventListener) {
                window.removeEventListener('deviceorientation', compassEventListener);
                compassEventListener = null;
            }
        }

        function calibrateCompass() {
            const btn = document.getElementById('calibrateBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengkalibrasi...';

            // Re-request location
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    qiblaData.latitude = position.coords.latitude;
                    qiblaData.longitude = position.coords.longitude;
                    calculateQibla();
                    getLocationName(qiblaData.latitude, qiblaData.longitude);

                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Kalibrasi Ulang';
                    showNotification('Kompas berhasil dikalibrasi');
                },
                (error) => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Kalibrasi Ulang';
                    showNotification('Gagal mengkalibrasi: ' + error.message, 'error');
                }
            );
        }

        // ==========================================
        // AUDIO PLAYER SYSTEM
        // ==========================================
        function getAudioUrl(ayah) {
            if (!ayah || !ayah.audio) return null;
            const preferences = ['05', '04', '03', '02', '01'];
            for (let pref of preferences) {
                if (ayah.audio[pref]) return ayah.audio[pref];
            }
            const keys = Object.keys(ayah.audio);
            if (keys.length > 0) return ayah.audio[keys[0]];
            return null;
        }

        function resetAllAudioUI() {
            document.querySelectorAll('.ayah-card').forEach(card => {
                card.classList.remove('playing');
            });
            document.querySelectorAll('.audio-btn').forEach(btn => {
                btn.classList.remove('playing');
                const icon = btn.querySelector('i');
                if (icon && !btn.id.includes('fullSurahBtn')) {
                    icon.className = 'fas fa-play';
                }
            });
            const fullSurahBtn = document.getElementById('fullSurahBtn');
            const fullSurahIcon = document.getElementById('fullSurahBtnIcon');
            const fullSurahText = document.getElementById('fullSurahBtnText');
            if (fullSurahBtn) fullSurahBtn.classList.remove('playing');
            if (fullSurahIcon) fullSurahIcon.className = 'fas fa-play';
            if (fullSurahText) fullSurahText.textContent = 'Putar Murottal';
        }

        function stopAllAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio.onended = null;
                currentAudio.onerror = null;
                currentAudio.onpause = null;
                currentAudio = null;
            }
            isPlayingFullSurah = false;
            resetAllAudioUI();
        }

        function playAyah(index) {
            if (currentPlayingAyahIndex === index && currentAudio && !isPlayingFullSurah) {
                stopAllAudio();
                return;
            }
            stopAllAudio();
            isPlayingFullSurah = false;
            currentPlayingAyahIndex = index;

            if (!currentSurah || !currentSurah.ayat[index]) {
                showNotification('Ayat tidak ditemukan', 'error');
                return;
            }

            const ayah = currentSurah.ayat[index];
            const audioUrl = getAudioUrl(ayah);

            if (!audioUrl) {
                showNotification('Audio tidak tersedia untuk ayat ini', 'error');
                return;
            }

            currentAudio = new Audio(audioUrl);
            const ayahCard = document.getElementById(`ayah-${index}`);
            const playBtn = ayahCard ? ayahCard.querySelector('.audio-btn') : null;
            const playIcon = playBtn ? playBtn.querySelector('i') : null;

            if (ayahCard) ayahCard.classList.add('playing');
            if (playBtn) playBtn.classList.add('playing');
            if (playIcon) playIcon.className = 'fas fa-pause';

            if (ayahCard) {
                ayahCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            currentAudio.play().catch(err => {
                console.error('Audio play error:', err);
                showNotification('Gagal memutar audio', 'error');
                stopAllAudio();
            });

            currentAudio.onended = () => {
                stopAllAudio();
            };

            currentAudio.onerror = () => {
                console.error('Audio error');
                stopAllAudio();
                showNotification('Error memuat audio', 'error');
            };
        }

        function toggleFullSurah() {
            if (isPlayingFullSurah && currentAudio) {
                stopAllAudio();
                currentPlayingAyahIndex = 0;
                return;
            }
            if (currentAudio) {
                stopAllAudio();
            }
            isPlayingFullSurah = true;
            const fullSurahBtn = document.getElementById('fullSurahBtn');
            const fullSurahIcon = document.getElementById('fullSurahBtnIcon');
            const fullSurahText = document.getElementById('fullSurahBtnText');
            if (fullSurahBtn) fullSurahBtn.classList.add('playing');
            if (fullSurahIcon) fullSurahIcon.className = 'fas fa-pause';
            if (fullSurahText) fullSurahText.textContent = 'Jeda';
            playNextAyahInSequence();
        }

        function playNextAyahInSequence() {
            if (!isPlayingFullSurah || !currentSurah) {
                stopAllAudio();
                return;
            }
            if (currentPlayingAyahIndex >= currentSurah.ayat.length) {
                showNotification('Selesai memutar surah', 'success');
                stopAllAudio();
                currentPlayingAyahIndex = 0;
                return;
            }

            const ayah = currentSurah.ayat[currentPlayingAyahIndex];
            const audioUrl = getAudioUrl(ayah);

            if (!audioUrl) {
                currentPlayingAyahIndex++;
                playNextAyahInSequence();
                return;
            }

            resetAllAudioUI();
            const ayahCard = document.getElementById(`ayah-${currentPlayingAyahIndex}`);
            const playBtn = ayahCard ? ayahCard.querySelector('.audio-btn') : null;
            const playIcon = playBtn ? playBtn.querySelector('i') : null;

            if (ayahCard) ayahCard.classList.add('playing');
            if (playBtn) playBtn.classList.add('playing');
            if (playIcon) playIcon.className = 'fas fa-pause';

            const fullSurahBtn = document.getElementById('fullSurahBtn');
            const fullSurahIcon = document.getElementById('fullSurahBtnIcon');
            const fullSurahText = document.getElementById('fullSurahBtnText');
            if (fullSurahBtn) fullSurahBtn.classList.add('playing');
            if (fullSurahIcon) fullSurahIcon.className = 'fas fa-pause';
            if (fullSurahText) fullSurahText.textContent = 'Jeda';

            if (ayahCard) {
                ayahCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            currentAudio = new Audio(audioUrl);
            currentAudio.play().catch(err => {
                console.error('Audio play error:', err);
                currentPlayingAyahIndex++;
                playNextAyahInSequence();
            });

            currentAudio.onended = () => {
                currentPlayingAyahIndex++;
                playNextAyahInSequence();
            };

            currentAudio.onerror = () => {
                console.error('Audio error on ayah', currentPlayingAyahIndex);
                currentPlayingAyahIndex++;
                playNextAyahInSequence();
            };
        }

        // ==========================================
        // QURAN FUNCTIONS
        // ==========================================
        async function loadSurahList() {
            try {
                const response = await fetch('https://equran.id/api/v2/surat');
                const data = await response.json();
                allSurahs = data.data;
                renderSurahList(allSurahs);
            } catch (error) {
                showNotification('Gagal memuat daftar surah', 'error');
            }
        }

        function renderSurahList(surahs) {
            const surahList = document.getElementById('surahList');
            surahList.innerHTML = '';
            surahs.forEach(surah => {
                const surahDiv = document.createElement('div');
                surahDiv.className = 'surah-item';
                surahDiv.onclick = () => openSurah(surah.nomor);
                surahDiv.innerHTML = `
                    <div class="surah-number">${surah.nomor}</div>
                    <div style="font-weight: 600; margin-bottom: 5px;">${surah.namaLatin}</div>
                    <div style="font-size: 0.9em; color: #666;">${surah.arti} â€¢ ${surah.jumlahAyat} Ayat</div>
                    <div style="font-family: 'Amiri', serif; font-size: 1.3em; text-align: right; margin-top: 10px;">
                        ${surah.nama}
                    </div>
                `;
                surahList.appendChild(surahDiv);
            });
        }

        function filterSurah() {
            const query = document.getElementById('searchSurah').value.toLowerCase();
            const filtered = allSurahs.filter(s =>
                s.namaLatin.toLowerCase().includes(query) ||
                s.arti.toLowerCase().includes(query) ||
                s.nomor.toString() === query
            );
            renderSurahList(filtered);
        }

        async function loadJuz() {
            const juzNo = document.getElementById('juzSelect').value;
            if (!juzNo) {
                renderSurahList(allSurahs);
                return;
            }
            try {
                document.getElementById('surahList').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                const response = await fetch(`https://api.myquran.com/v2/quran/ayat/juz/${juzNo}`);
                const data = await response.json();

                let tajweedVerses = [];
                let page = 1;
                while (page <= 2) {
                    const qRes = await fetch(`https://api.quran.com/api/v4/verses/by_juz/${juzNo}?language=id&words=true&word_fields=text_uthmani_tajweed,transliteration&translations=33&page=${page}&per_page=300`);
                    if (!qRes.ok) break;
                    const qData = await qRes.json();
                    if (qData.verses) tajweedVerses = tajweedVerses.concat(qData.verses);
                    if (!qData.pagination || page >= qData.pagination.total_pages) break;
                    page++;
                }

                const uniqueSurahs = [...new Set(data.data.map(item => item.surah))];
                let tafsirCache = {};
                for (let s of uniqueSurahs) {
                    try {
                        const tRes = await fetch(`https://equran.id/api/v2/tafsir/${s}`);
                        if (tRes.ok) {
                            const tData = await tRes.json();
                            tafsirCache[s] = tData.data.tafsir;
                        }
                    } catch (e) { }
                }

                const ayatList = data.data.map((item, i) => {
                    const findSurah = allSurahs.find(s => s.nomor == item.surah);
                    let tafsirText = '';
                    if (tafsirCache[item.surah]) {
                        const t = tafsirCache[item.surah].find(x => x.ayat == item.ayah);
                        if (t) tafsirText = t.teks;
                    }

                    return {
                        nomorAyat: item.ayah,
                        teksArab: item.arab,
                        teksLatin: item.latin,
                        teksIndonesia: item.text,
                        audio: { "01": item.audio },
                        surah: findSurah || { nomor: item.surah, namaLatin: 'Surah ' + item.surah },
                        words: tajweedVerses[i] ? tajweedVerses[i].words : null,
                        tafsir: tafsirText
                    };
                });

                currentSurah = {
                    namaLatin: `Juz ${juzNo}`,
                    arti: `Kumpulan ayat-ayat Juz ${juzNo}`,
                    jumlahAyat: ayatList.length,
                    tempatTurun: '',
                    ayat: ayatList
                };
                currentPlayingAyahIndex = 0;

                document.getElementById('surahListView').style.display = 'none';
                document.getElementById('surahDetailView').style.display = 'block';
                document.getElementById('searchAyah').value = '';

                renderSurahDetail(currentSurah.namaLatin, currentSurah.arti, currentSurah.jumlahAyat, currentSurah.tempatTurun, false);
            } catch (error) {
                console.error(error);
                showNotification('Gagal memuat Juz', 'error');
                renderSurahList(allSurahs);
            }
        }

        async function openSurah(surahNumber) {
            try {
                document.getElementById('surahListView').style.display = 'none';
                document.getElementById('surahDetailView').style.display = 'block';
                document.getElementById('surahContent').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                const response = await fetch(`https://equran.id/api/v2/surat/${surahNumber}`);
                const data = await response.json();
                currentSurah = data.data;
                currentPlayingAyahIndex = 0;

                const quranComRes = await fetch(`https://api.quran.com/api/v4/verses/by_chapter/${surahNumber}?language=id&words=true&word_fields=text_uthmani,text_indopak,text_uthmani_tajweed,transliteration&translations=${currentTranslationId}&per_page=300`);
                if (quranComRes.ok) {
                    const quranComData = await quranComRes.json();

                    let tafsirData = null;
                    try {
                        const tafsirRes = await fetch(`https://equran.id/api/v2/tafsir/${surahNumber}`);
                        if (tafsirRes.ok) tafsirData = await tafsirRes.json();
                    } catch (e) { }

                    currentSurah.ayat.forEach((ayah, i) => {
                        if (quranComData.verses && quranComData.verses[i]) {
                            ayah.words = quranComData.verses[i].words;
                            if (quranComData.verses[i].translations && quranComData.verses[i].translations.length > 0) {
                                let rawTranslation = quranComData.verses[i].translations[0].text;
                                // Hapus tag <sup> beserta isinya (footnote/angka)
                                rawTranslation = rawTranslation.replace(/<sup[^>]*>.*?<\/sup>/g, '');
                                // Hapus sisa tag HTML
                                ayah.teksIndonesia = rawTranslation.replace(/<[^>]*>?/gm, '').trim();
                            }
                        }
                        if (tafsirData && tafsirData.data && tafsirData.data.tafsir && tafsirData.data.tafsir[i]) {
                            ayah.tafsir = tafsirData.data.tafsir[i].teks;
                        }
                    });
                }

                document.getElementById('searchAyah').value = '';

                renderSurahDetail(currentSurah.namaLatin, currentSurah.arti, currentSurah.jumlahAyat, currentSurah.tempatTurun, surahNumber != 1 && surahNumber != 9);

                trackQuranReading(0, surahNumber, currentSurah.namaLatin, false);

            } catch (error) {
                console.error('Error opening surah:', error);
                showNotification('Gagal memuat surah', 'error');
            }
        }

        async function updateQuranSettings() {
            const scriptSelect = document.getElementById('arabicScript');
            const translationSelect = document.getElementById('translationSelect');
            const tajweedToggle = document.getElementById('tajweedToggle');

            if (scriptSelect) currentArabicScript = scriptSelect.value;

            if (tajweedToggle) {
                currentTajweedOn = tajweedToggle.checked;
                if (currentTajweedOn) {
                    document.body.classList.add('tajweed-active');
                } else {
                    document.body.classList.remove('tajweed-active');
                }
            }

            if (translationSelect) {
                const oldTranslation = currentTranslationId;
                currentTranslationId = translationSelect.value;
                if (oldTranslation !== currentTranslationId && currentSurah && currentSurah.nomor) {
                    await openSurah(currentSurah.nomor);
                    return;
                }
            }
            if (currentSurah) {
                renderSurahDetail(currentSurah.namaLatin, currentSurah.arti, currentSurah.jumlahAyat, currentSurah.tempatTurun, currentSurah.nomor != 1 && currentSurah.nomor != 9);
            }
        }

        function renderSurahDetail(namaLatin, arti, jumlahAyat, tempatTurun, isBismillah) {
            const content = document.getElementById('surahContent');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: var(--primary); font-size: 2em; font-weight: 700;">${namaLatin}</h2>
                    <p style="color: var(--text-secondary); margin-top: 5px;">${arti} â€¢ ${jumlahAyat} Ayat ${tempatTurun ? 'â€¢ ' + tempatTurun : ''}</p>
                    <button class="btn-primary" onclick="showHadithModal()" style="margin-top: 20px; background: rgba(229, 180, 67, 0.15); border: 1px solid var(--accent); padding: 10px 20px; border-radius: 50px; cursor: pointer; color: var(--accent); display: inline-flex; align-items: center; gap: 8px; font-weight: 600; box-shadow: none;">
                        <i class="fas fa-search"></i> Cari Hadits Terkait Surah Ini
                    </button>
                </div>
                ${isBismillah ? '<div class="bismillah" style="text-align: center; margin: 30px 0; font-family: \'Amiri\', serif; font-size: 2em; color: var(--primary);">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‘Ù°Ù‡Ù Ø§Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…Ù°Ù†Ù Ø§Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ’Ù…Ù</div>' : ''}
            `;

            currentSurah.ayat.forEach((ayah, index) => {
                const ayahCard = document.createElement('div');
                ayahCard.className = 'ayah-card';
                ayahCard.id = `ayah-${index}`;

                const sName = ayah.surah ? ayah.surah.namaLatin : namaLatin;
                const sNum = ayah.surah ? ayah.surah.nomor : (currentSurah.nomor || 0);

                let wordsHtml = '';
                if (ayah.words) {
                    wordsHtml = '<div class="verse-container">';
                    ayah.words.forEach((word, wordIndex) => {
                        let scriptKey = currentArabicScript;
                        if (currentTajweedOn && currentArabicScript === 'text_uthmani') {
                            scriptKey = 'text_uthmani_tajweed';
                        }
                        let arabicContent = word[scriptKey] || word.text_uthmani || word.text;

                        // Menghapus karakter blank/zero-width yang sering menjadi kotak di browser
                        if (typeof arabicContent === 'string') {
                            arabicContent = arabicContent.replace(/[\u200B-\u200F\uFEFF]/g, '');
                        }

                        if (word.char_type_name === 'word' || word.char_type_name === 'pause' || word.char_type_name === 'sajdah') {
                            wordsHtml += `
                                <div class="word-group" onclick="showWordDetailModal(${index}, ${wordIndex})">
                                    <div class="word-arabic">${arabicContent}</div>
                                </div>
                            `;
                        }
                        // Karakter tipe 'end' (nomor ayat di akhir) disembunyikan agar tidak memunculkan kotak rusak
                    });
                    wordsHtml += '</div>';
                } else {
                    wordsHtml = `<div class="arabic-text">${ayah.teksArab}</div>`;
                }

                ayahCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <span class="ayah-number">${ayah.nomorAyat}</span>
                        <button class="audio-btn" onclick="playAyah(${index})" title="Putar Ayat">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                    ${wordsHtml}
                    <div class="latin-text" style="font-size: var(--latin-font-size, 1.1em); margin-bottom: 15px; color: var(--primary);">
                        ${ayah.teksLatin || ayah.latin || ''}
                    </div>
                    <div class="translation">
                        <strong>Terjemahan:</strong><br>
                        ${ayah.teksIndonesia}
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; border-top: 1px solid var(--border); padding-top: 15px;">
                        ${ayah.tafsir ? `
                        <button class="btn-primary" onclick="showTafsirModal(${index})" style="background: var(--primary); border:none; padding: 8px 15px; border-radius: 5px; cursor: pointer; color: white; display: inline-flex; align-items: center; gap: 5px; font-size: 0.9em; box-shadow: none;">
                            <i class="fas fa-book"></i> Tafsir
                        </button>` : ''}

                        
                        <div style="flex-grow: 1;"></div>
                        
                        <button class="btn-primary btn-success" onclick="markAyahAsRead(${index}, ${sNum}, '${sName}')" style="background: #10B981; border:none; padding: 8px 15px; border-radius: 5px; cursor: pointer; color: white; display: inline-flex; align-items: center; gap: 5px; font-size: 0.9em; box-shadow: none;">
                            <i class="fas fa-check"></i> Tandai Sudah Dibaca & Catat di Kegiatan
                        </button>
                    </div>
                `;
                content.appendChild(ayahCard);
            });
        }

        function filterAyah() {
            const query = document.getElementById('searchAyah').value.toLowerCase();
            const cards = document.querySelectorAll('.ayah-card');
            cards.forEach((card, index) => {
                const ayah = currentSurah.ayat[index];
                if (ayah.teksIndonesia.toLowerCase().includes(query) ||
                    ayah.nomorAyat.toString() === query ||
                    ayah.teksArab.includes(query) ||
                    (ayah.surah && ayah.surah.namaLatin.toLowerCase().includes(query))) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function backToSurahList() {
            stopAllAudio();
            currentPlayingAyahIndex = 0;
            currentSurah = null;
            document.getElementById('surahListView').style.display = 'block';
            document.getElementById('surahDetailView').style.display = 'none';
            const juzSelect = document.getElementById('juzSelect');
            if (juzSelect) juzSelect.value = '';
            if (allSurahs.length > 0) renderSurahList(allSurahs);
            document.getElementById('searchSurah').value = '';
        }

        function showWordDetailModal(ayahIndex, wordIndex) {
            const ayah = currentSurah.ayat[ayahIndex];
            const word = ayah.words[wordIndex];

            document.getElementById('wordModal').querySelector('.modal-header h3').innerText = 'Detail Kata';

            let modalHtml = `
                <div style="font-family: 'Amiri', serif; font-size: 3em; margin-bottom: 10px; direction: rtl;" class="word-arabic">${word.text_uthmani_tajweed || word.text}</div>
                <div style="font-size: 1.2em; color: var(--primary); font-weight: bold; margin-bottom: 5px;">${word.transliteration && word.transliteration.text ? word.transliteration.text : ''}</div>
                <div style="margin-bottom: 15px; font-size: 1.1em; color: var(--text-secondary);">${word.translation && word.translation.text ? word.translation.text : ''}</div>
            `;
            document.getElementById('wordModalBody').innerHTML = modalHtml;
            document.getElementById('wordModal').style.display = 'block';
        }



        function showTafsirModal(ayahIndex) {
            const ayah = currentSurah.ayat[ayahIndex];
            document.getElementById('wordModal').querySelector('.modal-header h3').innerText = 'Tafsir Kemenag';

            let modalHtml = `
                <div style="text-align: left;">
                    <p style="color: var(--text); font-size:1.1em; line-height: 1.6; text-align:justify;">${ayah.tafsir.replace(/\\n/g, '<br>')}</p>
                </div>
            `;
            document.getElementById('wordModalBody').innerHTML = modalHtml;
            document.getElementById('wordModal').style.display = 'block';
        }

        // Cache for hadith data so we don't re-download 13MB every click
        const haditsCache = {};

        function showHadithModal() {
            const wordModalContent = document.getElementById('wordModal').querySelector('.modal-content');
            wordModalContent.style.maxWidth = '800px'; // make it wider for hadith search

            document.getElementById('wordModal').querySelector('.modal-header h3').innerText = 'Cari Hadith Terkait';

            const queryId = currentSurah.namaLatin; // E.g., Al-Baqarah, Al-Mulk

            let modalHtml = `
                <div style="text-align: center; padding: 10px;">
                    <p style="color: var(--text); margin-bottom: 15px;">
                        Cari hadits yang memuat topik atau penyebutan <strong>Surah ${queryId}</strong>
                    </p>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                        <select id="searchHaditsSource" class="btn-primary" style="flex: 1; min-width: 150px; padding: 10px; border-radius: 8px;">
                            <option value="bukhari">Shahih Bukhari</option>
                            <option value="muslim">Shahih Muslim</option>
                            <option value="tirmidzi">Sunan At-Tirmidzi</option>
                            <option value="nasai">Sunan An-Nasa'i</option>
                            <option value="abu-dawud">Sunan Abu Daud</option>
                            <option value="ibnu-majah">Sunan Ibnu Majah</option>
                            <option value="ahmad">Musnad Ahmad</option>
                            <option value="darimi">Sunan Ad-Darimi</option>
                            <option value="malik">Muwatta Malik</option>
                        </select>
                        <input type="text" id="searchHaditsKeyword" value="${queryId}" class="btn-primary" style="flex: 2; min-width: 200px; padding: 10px; border-radius: 8px; background: var(--card); color: var(--text); border: 2px solid var(--border);" placeholder="Kata kunci...">
                        <button onclick="searchRelatedHadith()" class="btn-primary" style="padding: 10px 20px; background: var(--accent); color: white; flex: 1; min-width: 100px;">
                            <i class="fas fa-search"></i> Cari
                        </button>
                    </div>
                    <div id="relatedHaditsResult" style="max-height: 50vh; overflow-y: auto; text-align: left; padding: 15px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg);">
                        <em style="color: var(--text-secondary);">Silakan tekan tombol Cari untuk menemukan hadits (membutuhkan waktu untuk unduh data awal per perawi).</em>
                    </div>
                </div>
            `;
            document.getElementById('wordModalBody').innerHTML = modalHtml;
            document.getElementById('wordModal').style.display = 'block';

            // Allow pressing enter
            setTimeout(() => {
                const searchInput = document.getElementById('searchHaditsKeyword');
                if (searchInput) {
                    searchInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            searchRelatedHadith();
                        }
                    });
                }
            }, 100);
        }

        async function searchRelatedHadith() {
            const source = document.getElementById('searchHaditsSource').value;
            const keyword = document.getElementById('searchHaditsKeyword').value.toLowerCase();
            const resultDiv = document.getElementById('relatedHaditsResult');

            if (!keyword.trim()) {
                resultDiv.innerHTML = '<div style="color: #e74c3c; text-align:center;">Masukkan kata kunci pencarian.</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading" style="margin:20px 0;"><div class="spinner"></div></div><div style="text-align:center; color: var(--text);">Mengunduh & Mencari data...<br><small style="color: var(--text-secondary);">Proses pencarian kitab besar mungkin memakan waktu sebentar.</small></div>';

            try {
                let data = haditsCache[source];
                if (!data) {
                    const response = await fetch(`https://cdn.jsdelivr.net/gh/renomureza/hadis-api-id@master/src/data/${source}.json`);
                    if (!response.ok) throw new Error('API fetch failed');
                    data = await response.json();
                    haditsCache[source] = data; // Cache
                }

                // Filter data
                const filtered = data.filter(h => {
                    const idText = (h.id || h.indonesia || '').toLowerCase();
                    const arText = (h.arab || '');
                    return idText.includes(keyword) || arText.includes(keyword);
                });

                if (filtered.length === 0) {
                    resultDiv.innerHTML = `<div style="text-align:center; padding: 20px; color: var(--text);">Tidak ditemukan hadits yang mengandung kata <strong>"${keyword}"</strong> pada kitab ini.</div>`;
                    return;
                }

                const maxResults = 50;
                let html = `<div style="margin-bottom: 15px; font-weight: bold; color: var(--primary);">Ditemukan ${filtered.length} hadits (Menampilkan maksimal ${maxResults}):</div>`;

                filtered.slice(0, maxResults).forEach(h => {
                    html += `
                        <div class="hadits-card" style="margin-bottom: 15px; padding: 15px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 2px 5px var(--shadow);">
                            <div class="hadits-header" style="border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-bottom: 10px;">
                                <span class="hadits-source" style="font-weight: bold; color: var(--primary);">Hadits No. ${h.number}</span>
                            </div>
                            <div class="hadits-arab" style="font-family: 'Amiri', serif; font-size: 1.4em; text-align: right; margin-bottom: 15px; direction: rtl; line-height: 2;">
                                ${h.arab}
                            </div>
                            <div class="hadits-translation" style="font-size: 1.1em; line-height: 1.6; color: var(--text);">
                                ${h.id || h.indonesia}
                            </div>
                        </div>
                    `;
                });

                resultDiv.innerHTML = html;
            } catch (error) {
                console.error('Error memuat hadits', error);
                resultDiv.innerHTML = '<div style="color: #e74c3c; text-align:center;">Gagal memuat atau mencari data hadits. Pastikan koneksi internet stabil.</div>';
            }
        }

        function closeWordModal() {
            document.getElementById('wordModal').style.display = 'none';
            // Reset to default size in case it's used for actual word detail next time
            document.getElementById('wordModal').querySelector('.modal-content').style.maxWidth = '400px';
        }

        function changeFontSize(type, amount) {
            const root = document.documentElement;
            if (type === 'arabic') {
                let current = parseFloat(getComputedStyle(root).getPropertyValue('--arabic-font-size')) || 2.2;
                root.style.setProperty('--arabic-font-size', (current + amount) + 'em');
            } else {
                let current = parseFloat(getComputedStyle(root).getPropertyValue('--latin-font-size')) || 1.1;
                root.style.setProperty('--latin-font-size', (current + amount) + 'em');
            }
        }

        function showSettingsModal() {
            const wordModalContent = document.getElementById('wordModal').querySelector('.modal-content');
            wordModalContent.style.maxWidth = '400px';
            document.getElementById('wordModal').querySelector('.modal-header h3').innerText = 'Pengaturan Tampilan';

            const activeScriptStyle = `width: 100%; padding: 12px 15px; border-radius: 12px; background: var(--bg); color: var(--text); border: 1px solid var(--border); appearance: none; cursor: pointer; font-size: 1em; margin-bottom: 5px;`;

            let modalHtml = `
                <div style="text-align: left; padding: 10px 5px;">
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); font-size: 0.95em;">Gaya Huruf Arab</label>
                        <div style="position: relative;">
                            <select id="arabicScript" onchange="updateQuranSettings()" style="${activeScriptStyle}">
                                <option value="text_uthmani" ${currentArabicScript === 'text_uthmani' ? 'selected' : ''}>Khat Utsmani</option>
                                <option value="text_indopak" ${currentArabicScript === 'text_indopak' ? 'selected' : ''}>Khat IndoPak</option>
                            </select>
                            <i class="fas fa-chevron-down" style="position: absolute; right: 15px; top: 15px; color: var(--text-secondary); pointer-events: none;"></i>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label style="font-weight: 600; color: var(--primary); font-size: 0.95em;">Tajwid Berwarna</label>
                            <label class="switch">
                                <input type="checkbox" id="tajweedToggle" onchange="updateQuranSettings()" ${currentTajweedOn ? 'checked' : ''}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); background: rgba(var(--primary-rgb), 0.05); padding: 12px; border-radius: 12px; border: 1px solid var(--border);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left;">
                                <div onclick="showTajweedInfo('ghunnah')" style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='transparent'"><span style="color: #F59E0B; margin-right: 5px;">â¬¤</span> Ghunnah</div>
                                <div onclick="showTajweedInfo('idgham_bighunnah')" style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='transparent'"><span style="color: #8B5CF6; margin-right: 5px;">â¬¤</span> Idgham Bighunnah</div>
                                <div onclick="showTajweedInfo('idgham_bilaghunnah')" style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='transparent'"><span style="color: #9CA3AF; margin-right: 5px;">â¬¤</span> Idgham Bilaghunnah</div>
                                <div onclick="showTajweedInfo('idgham_mitslain')" style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='transparent'"><span style="color: #86EFAC; margin-right: 5px;">â¬¤</span> Idgham Mitslain</div>
                                <div onclick="showTajweedInfo('iqlab')" style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='transparent'"><span style="color: #3B82F6; margin-right: 5px;">â¬¤</span> Iqlab</div>
                                <div onclick="showTajweedInfo('ikhfa')" style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='transparent'"><span style="color: #EF4444; margin-right: 5px;">â¬¤</span> Ikhfa</div>
                                <div onclick="showTajweedInfo('ikhfa_syafawi')" style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='transparent'"><span style="color: #EC4899; margin-right: 5px;">â¬¤</span> Ikhfa Syafawi</div>
                                <div onclick="showTajweedInfo('qalqalah')" style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='transparent'"><span style="color: #10B981; margin-right: 5px;">â¬¤</span> Qalqalah</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); font-size: 0.95em;">Edisi Terjemahan</label>
                        <div style="position: relative;">
                            <select id="translationSelect" onchange="updateQuranSettings()" style="${activeScriptStyle}">
                                <option value="33" ${currentTranslationId === '33' ? 'selected' : ''}>Terjemahan Kemenag</option>
                                <option value="134" ${currentTranslationId === '134' ? 'selected' : ''}>Tafsir Jalalayn (ID)</option>
                                <option value="141" ${currentTranslationId === '141' ? 'selected' : ''}>Sabiq Company (ID)</option>
                                <option value="131" ${currentTranslationId === '131' ? 'selected' : ''}>Clear Quran (EN)</option>
                                <option value="85" ${currentTranslationId === '85' ? 'selected' : ''}>Abdel Haleem (EN)</option>
                            </select>
                            <i class="fas fa-chevron-down" style="position: absolute; right: 15px; top: 15px; color: var(--text-secondary); pointer-events: none;"></i>
                        </div>
                    </div>
                    <div style="margin-bottom: 25px;">
                        <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 600; color: var(--primary); font-size: 0.95em;">
                            <span>Ukuran Teks Arab</span>
                            <span style="font-family: 'Amiri', serif; font-size: 1.2em; font-weight: normal; color: var(--accent);">Ø¨ÙØ³Ù’Ù…Ù</span>
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="changeFontSize('arabic', -0.2)" class="btn-primary" style="flex: 1; margin: 0; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--primary); border: 1px solid var(--border); box-shadow: none;">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button onclick="changeFontSize('arabic', 0.2)" class="btn-primary" style="flex: 1; margin: 0; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--primary); border: 1px solid var(--border); box-shadow: none;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 600; color: var(--primary); font-size: 0.95em;">
                            <span>Ukuran Terjemahan</span>
                            <span style="font-weight: normal; font-size: 0.9em; color: var(--text-secondary);">Aa</span>
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="changeFontSize('latin', -0.1)" class="btn-primary" style="flex: 1; margin: 0; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--primary); border: 1px solid var(--border); box-shadow: none;">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button onclick="changeFontSize('latin', 0.1)" class="btn-primary" style="flex: 1; margin: 0; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--primary); border: 1px solid var(--border); box-shadow: none;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('wordModalBody').innerHTML = modalHtml;
            document.getElementById('wordModal').style.display = 'block';
        }

        function showTajweedInfo(type) {
            const tajweedInfo = {
                'ghunnah': { nama: 'Ghunnah', warna: '#F59E0B', desc: 'Mendengung. Dibaca dengan dengungan atau ditahan selama 2 harakat. Umumnya terjadi pada huruf Mim bertasydid dan Nun bertasydid.' },
                'idgham_bighunnah': { nama: 'Idgham Bighunnah', warna: '#8B5CF6', desc: 'Memasukkan dengan dengung. Terjadi bila Nun mati atau Tanwin bertemu dengan salah satu huruf Ya, Nun, Mim, atau Waw.' },
                'idgham_bilaghunnah': { nama: 'Idgham Bilaghunnah', warna: '#9CA3AF', desc: 'Memasukkan tanpa dengung. Terjadi bila Nun mati atau Tanwin bertemu dengan huruf Lam atau Ra.' },
                'idgham_mitslain': { nama: 'Idgham Mitslain (Mimi)', warna: '#86EFAC', desc: 'Mendengung. Terjadi secara khusus bila huruf Mim mati (sukun) bertemu dengan huruf Mim.' },
                'iqlab': { nama: 'Iqlab', warna: '#3B82F6', desc: 'Menukar bunyi Nun mati atau Tanwin menjadi bunyi Mim mati yang disertai dengungan, saat bertemu dengan huruf Ba.' },
                'ikhfa': { nama: 'Ikhfa', warna: '#EF4444', desc: 'Menyamarkan bunyi Nun mati atau Tanwin dengan dengungan yang ditarik, saat bertemu dengan ke-15 huruf Ikhfa.' },
                'ikhfa_syafawi': { nama: 'Ikhfa Syafawi', warna: '#EC4899', desc: 'Menyamarkan bunyi Mim mati (sukun) yang juga disertai dengan dengungan, saat bertemu huruf Ba.' },
                'qalqalah': { nama: 'Qalqalah', warna: '#10B981', desc: 'Memantulkan bunyi huruf. Terjadi jika huruf Qaf, Tha, Ba, Jim, Dal merupakan huruf yang terpantul karena mati/sukun.' }
            };

            const info = tajweedInfo[type];
            if (!info) return;

            const existingPopup = document.getElementById('tajweedPopup');
            const existingOverlay = document.getElementById('tajweedOverlay');
            if (existingPopup) existingPopup.remove();
            if (existingOverlay) existingOverlay.remove();

            const popupHtml = `
                <div id="tajweedOverlay" onclick="document.getElementById('tajweedPopup').remove(); this.remove();" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; animation: fadeIn 0.3s; backdrop-filter: blur(2px);"></div>
                <div id="tajweedPopup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); z-index: 9999; padding: 25px; width: 90%; max-width: 350px; text-align: center; border: 2px solid ${info.warna}; animation: fadeIn 0.3s;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: ${info.warna}20; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto 15px auto;">
                        <span style="color: ${info.warna}; font-size: 1.5em;">â¬¤</span>
                    </div>
                    <h3 style="color: var(--primary); margin-bottom: 10px; font-size: 1.3em;">${info.nama}</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; font-size: 0.95em;">${info.desc}</p>
                    <button onclick="document.getElementById('tajweedPopup').remove(); document.getElementById('tajweedOverlay').remove();" style="margin-top: 20px; background: ${info.warna}; color: white; border: none; padding: 10px 25px; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; font-family: 'Poppins', sans-serif; transition: transform 0.2s;" onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">Mengerti</button>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', popupHtml);
        }

        function markAyahAsRead(ayahIndex, surahNumber, surahName) {
            let newlyReadCount = 0;
            // Tandai ayat dari awal sampai ayat yang dipilih
            for (let i = 0; i <= ayahIndex; i++) {
                const ayahCard = document.getElementById(`ayah-${i}`);
                if (ayahCard && !ayahCard.classList.contains('read-marked')) {
                    ayahCard.classList.add('read-marked');
                    ayahCard.style.background = 'rgba(16, 185, 129, 0.08)'; // Subtle success background
                    ayahCard.style.borderLeft = '5px solid var(--success)';
                    newlyReadCount++;
                }
            }

            if (newlyReadCount > 0) {
                trackQuranReading(ayahIndex + 1, surahNumber, surahName, newlyReadCount);
                if (newlyReadCount === 1) {
                    showNotification(`Ayat ${ayahIndex + 1} ${surahName} tercatat di Kegiatan Harian!`);
                } else {
                    showNotification(`${newlyReadCount} Ayat (sampai ayat ${ayahIndex + 1}) dari ${surahName} tercatat!`);
                }
            }
        }

        // ==========================================
        // QURAN TRACKING
        // ==========================================
        function trackQuranReading(ayahNumber, surahNumber, surahName, manualCount) {
            const today = new Date().toDateString();
            if (quranStats.lastDate !== today) {
                if (quranStats.lastDate === new Date(Date.now() - 86400000).toDateString()) {
                    quranStats.streak++;
                } else if (quranStats.lastDate !== today) {
                    quranStats.streak = 1;
                }
                quranStats.ayahsRead = 0;
                quranStats.lastDate = today;
            }

            if (typeof manualCount === 'number' && manualCount > 0) {
                quranStats.ayahsRead += manualCount;
                quranStats.pagesRead = Math.ceil(quranStats.ayahsRead / 10);
            }

            quranStats.lastRead = {
                surah: surahName,
                ayah: ayahNumber,
                time: new Date()
            };

            completeActivity('tadarus');
            saveStats();
            updateReadingDisplay();
        }

        function completeActivity(activityId) {
            const today = new Date().toDateString();
            if (!activities[today]) activities[today] = {};
            activities[today][activityId] = true;
            localStorage.setItem('sijilActivities', JSON.stringify(activities));

            const checkbox = document.querySelector(`[data-activity="${activityId}"]`);
            if (checkbox && !checkbox.classList.contains('checked')) {
                checkbox.classList.add('checked');
                const item = checkbox.closest('.activity-item');
                if (item) item.classList.add('completed');
            }

            updateProgress();
        }

        function updateReadingDisplay() {
            document.getElementById('ayahsReadToday').textContent = quranStats.ayahsRead;
            document.getElementById('pagesReadToday').textContent = quranStats.pagesRead;
            document.getElementById('currentSurah').textContent = quranStats.lastRead ? quranStats.lastRead.surah : '-';
            document.getElementById('readingStreak').textContent = quranStats.streak;
        }

        // ==========================================
        // HADITS FUNCTIONS
        // ==========================================
        let currentHaditsData = [];
        let filteredHaditsData = [];
        let showHaditsLatin = false;

        function showHaditsSettingsModal() {
            const wordModalContent = document.getElementById('wordModal').querySelector('.modal-content');
            wordModalContent.style.maxWidth = '400px';
            document.getElementById('wordModal').querySelector('.modal-header h3').innerText = 'Pengaturan Hadits';

            let modalHtml = `
                <div style="text-align: left; padding: 10px 5px;">
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: var(--primary); font-size: 0.95em;">Tampilkan Teks Latin</span>
                            <label class="switch">
                                <input type="checkbox" id="haditsLatinToggle" onchange="applyHaditsSettings()" ${showHaditsLatin ? 'checked' : ''}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin: 0;">Catatan: Sistem asli tidak menyediakan latin secara native, ini adalah transliterasi eksperimental.</p>
                    </div>
                    <div>
                        <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 600; color: var(--primary); font-size: 0.95em;">
                            <span>Ukuran Arab</span>
                            <span style="font-weight: normal; font-size: 1.1em; font-family: 'Amiri', serif; color: var(--text-secondary);">Ø¨</span>
                        </label>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button onclick="changeFontSize('arabic', -0.2)" class="btn-primary" style="flex: 1; margin: 0; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--primary); border: 1px solid var(--border); box-shadow: none;">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button onclick="changeFontSize('arabic', 0.2)" class="btn-primary" style="flex: 1; margin: 0; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--primary); border: 1px solid var(--border); box-shadow: none;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 600; color: var(--primary); font-size: 0.95em;">
                            <span>Ukuran Terjemahan</span>
                            <span style="font-weight: normal; font-size: 0.9em; color: var(--text-secondary);">Aa</span>
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="changeFontSize('latin', -0.1)" class="btn-primary" style="flex: 1; margin: 0; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--primary); border: 1px solid var(--border); box-shadow: none;">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button onclick="changeFontSize('latin', 0.1)" class="btn-primary" style="flex: 1; margin: 0; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--primary); border: 1px solid var(--border); box-shadow: none;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('wordModalBody').innerHTML = modalHtml;
            document.getElementById('wordModal').style.display = 'block';
        }

        function applyHaditsSettings() {
            const toggle = document.getElementById('haditsLatinToggle');
            if (toggle) showHaditsLatin = toggle.checked;

            const container = document.getElementById('haditsContent');
            if (currentHaditsData.length > 0) {
                // Re-render current page
                container.innerHTML = '';
                displayHadits(filteredHaditsData.slice(0, haditsPage * 20));
            }
        }

        function simpleArabicToLatin(text) {
            // A very minimal/fallback arabic transliterator just for UI demonstration
            if (!text) return '';
            const arMap = {
                'Ø§': 'a', 'Ø¨': 'b', 'Øª': 't', 'Ø«': 'ts', 'Ø¬': 'j', 'Ø­': 'h', 'Ø®': 'kh',
                'Ø¯': 'd', 'Ø°': 'dz', 'Ø±': 'r', 'Ø²': 'z', 'Ø³': 's', 'Ø´': 'sy', 'Øµ': 'sh',
                'Ø¶': 'dh', 'Ø·': 'th', 'Ø¸': 'zh', 'Ø¹': "'", 'Øº': 'gh', 'Ù': 'f', 'Ù‚': 'q',
                'Ùƒ': 'k', 'Ù„': 'l', 'Ù…': 'm', 'Ù†': 'n', 'Ù‡': 'h', 'Ùˆ': 'w', 'ÙŠ': 'y',
                'ÙŽ': 'a', 'Ù': 'i', 'Ù': 'u', 'Ù‹': 'an', 'Ù': 'in', 'ÙŒ': 'un', 'Ù’': '', 'Ù‘': ''
            };
            return text.split('').map(char => arMap[char] || char).join('');
        }

        async function loadHadits() {
            let source = document.getElementById('haditsSource').value;
            if (source === 'abu-daud') source = 'abu-dawud'; // fix slug difference

            const sourceSelector = document.getElementById('haditsSource');
            const sourceName = sourceSelector.options[sourceSelector.selectedIndex].text;

            haditsPage = 1;
            document.getElementById('haditsContent').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            document.getElementById('searchMainHadits').value = '';
            document.getElementById('loadMoreHaditsBtn').style.display = 'none';
            document.getElementById('haditsInfoBar').innerText = 'Mengunduh Data...';

            try {
                let data = haditsCache[source];
                if (!data) {
                    const response = await fetch(`https://cdn.jsdelivr.net/gh/renomureza/hadis-api-id@master/src/data/${source}.json`);
                    if (!response.ok) throw new Error('API fetch failed');
                    data = await response.json();
                    haditsCache[source] = data;
                }

                currentHaditsData = data.map(h => ({
                    kitab: sourceName,
                    arab: h.arab,
                    indonesia: h.id || h.indonesia,
                    number: h.number,
                    latin: simpleArabicToLatin(h.arab)
                }));

                filteredHaditsData = [...currentHaditsData];

                document.getElementById('haditsInfoBar').innerHTML = `<i class="fas fa-list"></i> Total Hadits: ${currentHaditsData.length} dalam Kitab Ini`;

                if (filteredHaditsData.length > 20) {
                    document.getElementById('loadMoreHaditsBtn').style.display = 'inline-block';
                }

                displayHadits(filteredHaditsData.slice(0, 20));
            } catch (error) {
                console.error('Error memuat hadits', error);
                document.getElementById('haditsContent').innerHTML = '<div style="text-align:center; padding: 20px;">Gagal memuat data hadits. Pastikan koneksi internet stabil.</div>';
                showNotification('Gagal memuat hadits', 'error');
            }
        }

        function displayHadits(haditsList, append = false) {
            const container = document.getElementById('haditsContent');
            if (!append) container.innerHTML = '';

            if (haditsList.length === 0 && !append) {
                container.innerHTML = '<div style="text-align:center; padding: 20px;">Pencarian tidak ditemukan.</div>';
                return;
            }

            haditsList.forEach((hadits) => {
                const haditsCard = document.createElement('div');
                haditsCard.className = 'hadits-card';
                haditsCard.id = `hadits-${hadits.number}`;

                let latinHtml = showHaditsLatin ? `<div class="latin-text" style="font-size: var(--latin-font-size, 1.1em); margin-bottom: 15px; color: var(--primary); text-align: left;">${hadits.latin}</div>` : '';

                haditsCard.innerHTML = `
                    <div class="hadits-header">
                        <span class="hadits-source">${hadits.kitab}</span>
                        <span style="color: #666; font-size: 0.9em; font-weight: bold;">Hadits No. ${hadits.number}</span>
                    </div>
                    <div class="hadits-arab" style="font-size: var(--arabic-font-size, 2.2em);">${hadits.arab || ''}</div>
                    ${latinHtml}
                    <div class="hadits-translation" style="font-size: var(--latin-font-size, 1.1em);">${hadits.indonesia || ''}</div>
                `;
                container.appendChild(haditsCard);
            });
        }

        function filterMainHadits() {
            const query = document.getElementById('searchMainHadits').value.toLowerCase();
            if (!query) {
                filteredHaditsData = [...currentHaditsData];
            } else {
                filteredHaditsData = currentHaditsData.filter(h =>
                    (h.indonesia && h.indonesia.toLowerCase().includes(query)) ||
                    (h.number && h.number.toString().includes(query)) ||
                    (h.arab && h.arab.includes(query))
                );
            }

            haditsPage = 1;
            displayHadits(filteredHaditsData.slice(0, 20));

            document.getElementById('haditsInfoBar').innerHTML = `<i class="fas fa-list"></i> Ditemukan ${filteredHaditsData.length} Hadits`;
            document.getElementById('loadMoreHaditsBtn').style.display = filteredHaditsData.length > 20 ? 'inline-block' : 'none';
        }

        function jumpToHadits() {
            const targetNo = document.getElementById('jumpHaditsInput').value.trim();
            if (!targetNo) return;

            // Search inside filteredHaditsData array for the exact number match
            const targetIndex = filteredHaditsData.findIndex(h => h.number.toString() === targetNo);

            if (targetIndex !== -1) {
                // If it's beyond the currently loaded page, we need to load enough pages to render it
                if (targetIndex >= haditsPage * 20) {
                    haditsPage = Math.ceil((targetIndex + 1) / 20);
                    displayHadits(filteredHaditsData.slice(0, haditsPage * 20));
                }

                const card = document.getElementById(`hadits-${targetNo}`);
                if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.style.transition = 'box-shadow 0.3s, border 0.3s';
                    card.style.boxShadow = '0 0 15px var(--accent)';
                    card.style.border = '2px solid var(--accent)';
                    setTimeout(() => {
                        card.style.boxShadow = '';
                        card.style.border = '';
                    }, 2000);
                }
            } else {
                showNotification(`Hadits nomor ${targetNo} tidak ditemukan`, 'error');
            }
        }

        function loadMoreHadits() {
            if (!filteredHaditsData || filteredHaditsData.length === 0) return;

            const start = haditsPage * 20;
            const end = start + 20;
            const nextHadits = filteredHaditsData.slice(start, end);

            if (nextHadits.length > 0) {
                displayHadits(nextHadits, true);
                haditsPage++;
                if (end >= filteredHaditsData.length) {
                    document.getElementById('loadMoreHaditsBtn').style.display = 'none';
                }
            }
        }

        // ==========================================
        // PRAYER TIMES
        // ==========================================
        async function getPrayerTimes() {
            const city = document.getElementById('cityInput').value || 'Jakarta';
            const container = document.getElementById('prayerTimesContent');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${city}&country=Indonesia&method=11`);
                const data = await response.json();

                const timings = data.data.timings;
                const prayers = [
                    { name: 'Imsak', time: timings.Imsak, key: 'imsak' },
                    { name: 'Subuh', time: timings.Fajr, key: 'fajr' },
                    { name: 'Terbit', time: timings.Sunrise, key: 'sunrise' },
                    { name: 'Dzuhur', time: timings.Dhuhr, key: 'dhuhr' },
                    { name: 'Ashar', time: timings.Asr, key: 'asr' },
                    { name: 'Maghrib', time: timings.Maghrib, key: 'maghrib' },
                    { name: 'Isya', time: timings.Isha, key: 'isha' }
                ];

                let html = '<div class="prayer-times-grid">';
                const currentTime = new Date();
                const currentHour = currentTime.getHours();
                const currentMinute = currentTime.getMinutes();
                const currentTimeVal = currentHour * 60 + currentMinute;

                prayers.forEach(prayer => {
                    const [hour, minute] = prayer.time.split(':').map(Number);
                    const prayerTimeVal = hour * 60 + minute;
                    const isActive = Math.abs(currentTimeVal - prayerTimeVal) < 30;

                    html += `
                        <div class="prayer-card ${isActive ? 'active' : ''}">
                            <div class="prayer-name">${prayer.name}</div>
                            <div class="prayer-time">${prayer.time}</div>
                            ${isActive ? '<div style="font-size: 0.8em; margin-top: 5px;"><i class="fas fa-bell"></i> Waktu Ini</div>' : ''}
                        </div>
                    `;
                });
                html += '</div>';

                const date = data.data.date;
                html += `
                    <div style="margin-top: 30px; text-align: center; padding: 20px; background: var(--bg); border-radius: 15px;">
                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                            <i class="fas fa-calendar-day"></i> ${date.readable}
                        </h3>
                        <p style="color: #666;">
                            ${date.hijri.day} ${date.hijri.month.en} ${date.hijri.year} H
                        </p>
                        <p style="color: #666; margin-top: 5px;">
                            <i class="fas fa-location-dot"></i> ${city}, Indonesia
                        </p>
                    </div>
                `;

                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = '<p style="text-align: center; color: #e74c3c;">Gagal memuat jadwal shalat. Silakan coba lagi.</p>';
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    try {
                        const response = await fetch(`https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=11`);
                        const data = await response.json();
                        document.getElementById('cityInput').value = data.data.meta.timezone.split('/')[1] || 'Lokasi Anda';
                        getPrayerTimes();
                    } catch (error) {
                        showNotification('Gagal mendapatkan lokasi', 'error');
                    }
                });
            } else {
                showNotification('Browser tidak mendukung geolokasi', 'error');
            }
        }

        // ==========================================
        // SIJIL FUNCTIONS
        // ==========================================
        function initializeSijil() {
            const grid = document.getElementById('activityGrid');
            grid.innerHTML = '';

            Object.entries(activityCategories).forEach(([key, category]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'activity-category';

                let itemsHtml = '';
                category.items.forEach(item => {
                    const isCompleted = isActivityCompleted(item.id);
                    itemsHtml += `
                        <div class="activity-item ${isCompleted ? 'completed' : ''}">
                            <div class="activity-info">
                                <div class="activity-icon" style="background: ${category.color}">
                                    <i class="fas ${item.icon}"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${item.name}</div>
                                    ${item.autoTrack ? '<div style="font-size: 0.8em; color: #27ae60;"><i class="fas fa-robot"></i> Auto-track</div>' : ''}
                                </div>
                            </div>
                            <div class="checkbox-wrapper">
                                <div class="custom-checkbox ${isCompleted ? 'checked' : ''}" 
                                     data-activity="${item.id}"
                                     onclick="toggleActivity('${item.id}')">
                                </div>
                            </div>
                        </div>
                    `;
                });

                categoryDiv.innerHTML = `
                    <div class="category-title" style="border-color: ${category.color}">
                        <i class="fas ${category.icon}"></i>
                        ${category.title}
                    </div>
                    ${itemsHtml}
                `;

                grid.appendChild(categoryDiv);
            });

            updateProgress();
        }

        function isActivityCompleted(activityId) {
            const today = new Date().toDateString();
            return activities[today] && activities[today][activityId];
        }

        function toggleActivity(activityId) {
            const today = new Date().toDateString();
            if (!activities[today]) activities[today] = {};
            activities[today][activityId] = !activities[today][activityId];
            localStorage.setItem('sijilActivities', JSON.stringify(activities));
            initializeSijil();
            if (activities[today][activityId]) {
                showNotification('Alhamdulillah! Aktivitas tercatat.');
            }
        }

        function updateProgress() {
            const today = new Date().toDateString();
            if (!activities[today]) activities[today] = {};

            let total = 0;
            let completed = 0;
            let ibadah = 0, olahraga = 0, sosial = 0;
            let ibadahTotal = 0, olahragaTotal = 0, sosialTotal = 0;

            Object.entries(activityCategories).forEach(([catKey, category]) => {
                category.items.forEach(item => {
                    total++;
                    const isDone = activities[today][item.id];
                    if (isDone) {
                        completed++;
                        if (catKey === 'ibadah') ibadah++;
                        else if (catKey === 'olahraga') olahraga++;
                        else if (catKey === 'sosial') sosial++;
                    }

                    if (catKey === 'ibadah') ibadahTotal++;
                    else if (catKey === 'olahraga') olahragaTotal++;
                    else if (catKey === 'sosial') sosialTotal++;
                });
            });

            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('completedCount').textContent = completed;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressBar').style.width = percent + '%';

            document.getElementById('ibadahScore').textContent = `${ibadah}/${ibadahTotal}`;
            document.getElementById('olahragaScore').textContent = `${olahraga}/${olahragaTotal}`;
            document.getElementById('sosialScore').textContent = `${sosial}/${sosialTotal}`;
            document.getElementById('totalScore').textContent = completed;
        }

        function resetDailyStats() {
            if (confirm('Yakin ingin reset statistik hari ini?')) {
                const today = new Date().toDateString();
                activities[today] = {};
                quranStats.ayahsRead = 0;
                quranStats.pagesRead = 0;
                localStorage.setItem('sijilActivities', JSON.stringify(activities));
                saveStats();
                initializeSijil();
                updateReadingDisplay();
                showNotification('Statistik hari ini telah direset');
            }
        }

        // ==========================================
        // STORAGE FUNCTIONS
        // ==========================================
        function saveStats() {
            localStorage.setItem('quranStats', JSON.stringify(quranStats));
        }

        function loadStats() {
            const savedActivities = localStorage.getItem('sijilActivities');
            if (savedActivities) activities = JSON.parse(savedActivities);

            const savedStats = localStorage.getItem('quranStats');
            if (savedStats) {
                quranStats = JSON.parse(savedStats);
                updateReadingDisplay();
            }
        }

        function checkNewDay() {
            const today = new Date().toDateString();
            if (quranStats.lastDate && quranStats.lastDate !== today) {
                if (quranStats.lastDate !== new Date(Date.now() - 86400000).toDateString()) {
                    quranStats.streak = 0;
                }
            }
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.style.background = type === 'error' ? '#e74c3c' : '#27ae60';
            notif.style.display = 'block';
            setTimeout(() => {
                notif.style.display = 'none';
            }, 3000);
        }

        function closeModal() {
            document.getElementById('quranModal').classList.remove('active');
        }

        window.onbeforeunload = function () {
            saveStats();
            localStorage.setItem('sijilActivities', JSON.stringify(activities));
            stopCompass();
        };
    </script>
</body>

</html>